<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>> FEAR_GREED_PROTOCOL <</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #000; color: #fff; min-height: 100vh; overflow-x: hidden; position: relative; }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; }
        .container { text-align: center; max-width: 900px; width: 100%; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        .controls { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }
        .control-btn { background: rgba(0, 255, 0, 0.2); border: 2px solid #00ff00; color: #00ff00; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 1.2em; transition: all 0.3s ease; position: relative; }
        .control-btn:hover { background: rgba(0, 255, 0, 0.4); transform: scale(1.1); }
        .control-btn:hover::after { content: attr(data-tooltip); position: absolute; bottom: -40px; right: 0; background: rgba(0, 255, 0, 0.9); color: #000; padding: 5px 10px; border-radius: 5px; font-size: 0.7em; white-space: nowrap; z-index: 1000; }
        .control-btn.active { background: #00ff00; color: #000; box-shadow: 0 0 15px #00ff00; }
        .btc-ticker { background: linear-gradient(135deg, #f7931a 0%, #ffb74d 100%); padding: 15px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(247, 147, 26, 0.3); animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .btc-label { font-size: 0.9em; color: #000; opacity: 0.8; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
        .btc-price { font-size: 2.5em; font-weight: bold; color: #000; margin: 5px 0; }
        .btc-change { font-size: 1.2em; font-weight: bold; margin-top: 5px; }
        .positive { color: #00ff00; }
        .negative { color: #ff0000; }
        .title { font-size: 2.2em; color: #00ff00; margin-bottom: 25px; font-weight: bold; letter-spacing: 3px; text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00; animation: terminal-flicker 3s ease-in-out infinite; }
        @keyframes terminal-flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.95; } }
        .gauge { width: 400px; height: 400px; margin: 30px auto; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); transition: all 0.5s ease; box-shadow: 0 0 30px rgba(0,0,0,0.5); padding: 40px; }
        .gauge.extreme { animation: extreme-pulse 1s ease-in-out infinite; }
        @keyframes extreme-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .score { font-size: 5.5em; font-weight: bold; text-shadow: 0 0 30px currentColor; margin-bottom: 10px; }
        .status { font-size: 1.1em; margin-top: 15px; letter-spacing: 2px; font-weight: bold; text-transform: uppercase; line-height: 1.3; }
        .degen { font-size: 3em; font-family: 'Comic Sans MS', cursive, sans-serif; color: #fff; margin: 30px; font-weight: bold; text-shadow: 0 0 20px currentColor; animation: degen-bounce 2s ease-in-out infinite; }
        @keyframes degen-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .chart-container { background: rgba(255,255,255,0.05); border: 2px solid rgba(0, 255, 0, 0.3); border-radius: 15px; padding: 30px; margin: 40px 0; box-shadow: 0 0 20px rgba(0, 255, 0, 0.1); min-height: 300px; }
        .chart-title { color: #00ff00; font-size: 1.3em; margin-bottom: 20px; letter-spacing: 2px; text-transform: uppercase; }
        .btn { background: linear-gradient(135deg, #00ff00, #00cc00); border: 2px solid #00ff00; color: #000; padding: 15px 40px; font-size: 1.1em; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold; margin: 10px; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 0 15px rgba(0, 255, 0, 0.3); transition: all 0.3s ease; }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(0, 255, 0, 0.6); }
        .share-btn { background: #000; border: 2px solid #fff; color: #fff; display: inline-flex; align-items: center; gap: 10px; }
        .share-btn:hover { box-shadow: 0 0 25px rgba(255, 255, 255, 0.6); background: #111; }
        .x-logo { font-size: 1.2em; font-weight: bold; }
        @media (max-width: 768px) { .title { font-size: 1.5em; } .degen { font-size: 2em; } .btc-price { font-size: 2em; } .gauge { width: 300px; height: 300px; padding: 30px; } .score { font-size: 4em; } .status { font-size: 0.9em; } .controls { top: 10px; right: 10px; flex-direction: column; } .chart-container { padding: 15px; } }
    </style>
</head>
<body>
    <canvas id="matrix-canvas"></canvas>
    <div class="controls">
        <button class="control-btn active" id="soundToggle" data-tooltip="Toggle Sound Effects">üîä</button>
        <button class="control-btn active" id="particlesToggle" data-tooltip="Toggle Matrix Effect">‚ú®</button>
        <button class="control-btn" id="notifyToggle" data-tooltip="Get alerts at extreme levels">üîî</button>
    </div>
    <div class="container">
        <div class="btc-ticker"><div class="btc-label">‚Çø Bitcoin</div><div class="btc-price" id="btcPrice">Loading...</div><div class="btc-change" id="btcChange"></div></div>
        <div class="title">&gt; FEAR_GREED_PROTOCOL &lt;</div>
        <div id="content">Loading...</div>
        <div class="chart-container"><div class="chart-title">üìä 30-Day Sentiment History</div><canvas id="historyChart"></canvas></div>
        <button class="btn share-btn" onclick="shareToX()"><span class="x-logo">ùïè</span> Share on X</button>
    </div>
    <script>
        let currentScore=0,soundEnabled=true,particlesEnabled=true,notificationsEnabled=false,lastNotificationScore=null,audioContext,currentOscillator=null;
        
        // Initialize Web Audio API for sound
        function initAudio(){
            if(!audioContext){
                audioContext=new(window.AudioContext||window.webkitAudioContext)();
            }
        }
        
        // Play sound for each state
        function playSound(state){
            if(!soundEnabled)return;
            initAudio();
            
            // Stop previous sound
            if(currentOscillator){
                currentOscillator.stop();
                currentOscillator=null;
            }
            
            const oscillator=audioContext.createOscillator();
            const gainNode=audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Different frequencies for different states
            const sounds={
                extreme_fear:{freq:110,type:'sawtooth',duration:0.5},
                fear:{freq:220,type:'sine',duration:0.3},
                neutral:{freq:440,type:'triangle',duration:0.2},
                greed:{freq:660,type:'sine',duration:0.3},
                extreme_greed:{freq:880,type:'square',duration:0.5}
            };
            
            const sound=sounds[state]||sounds.neutral;
            oscillator.type=sound.type;
            oscillator.frequency.setValueAtTime(sound.freq,audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3,audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+sound.duration);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime+sound.duration);
            currentOscillator=oscillator;
        }
        
        function getSoundStateForScore(s){
            if(s<20)return 'extreme_fear';
            if(s<40)return 'fear';
            if(s<60)return 'neutral';
            if(s<80)return 'greed';
            return 'extreme_greed';
        }
        
        // Matrix effect
        const canvas=document.getElementById('matrix-canvas'),ctx=canvas.getContext('2d');
        canvas.width=window.innerWidth;canvas.height=window.innerHeight;
        const matrix="ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%";
        const fontSize=14,columns=canvas.width/fontSize;
        const drops=[];
        for(let i=0;i<columns;i++)drops[i]=1;
        
        function drawMatrix(){
            if(!particlesEnabled)return;
            ctx.fillStyle='rgba(0,0,0,0.05)';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle='#0F0';
            ctx.font=fontSize+'px monospace';
            for(let i=0;i<drops.length;i++){
                const text=matrix[Math.floor(Math.random()*matrix.length)];
                ctx.fillText(text,i*fontSize,drops[i]*fontSize);
                if(drops[i]*fontSize>canvas.height&&Math.random()>0.975)drops[i]=0;
                drops[i]++;
            }
        }
        setInterval(drawMatrix,35);
        
        window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;});
        
        function getColorForScore(s){return s<20?'#ff4444':s<40?'#ff8844':s<60?'#ffd700':s<80?'#88ff44':'#44ff88';}
        
        document.getElementById('soundToggle').addEventListener('click',function(){
            soundEnabled=!soundEnabled;
            this.classList.toggle('active');
            this.textContent=soundEnabled?'üîä':'üîá';
            if(soundEnabled){
                initAudio();
                playSound(getSoundStateForScore(currentScore));
            }
        });
        
        document.getElementById('particlesToggle').addEventListener('click',function(){
            particlesEnabled=!particlesEnabled;
            this.classList.toggle('active');
            if(!particlesEnabled){ctx.fillStyle='rgba(0,0,0,1)';ctx.fillRect(0,0,canvas.width,canvas.height);}
        });
        
        document.getElementById('notifyToggle').addEventListener('click',async function(){
            if(!notificationsEnabled&&'Notification'in window){
                const p=await Notification.requestPermission();
                if(p==='granted'){
                    notificationsEnabled=true;
                    this.classList.add('active');
                    new Notification('üîî Alerts Enabled!',{body:'You will be notified at extreme F&G levels'});
                }
            }else{
                notificationsEnabled=false;
                this.classList.remove('active');
            }
        });
        
        async function fetchBTCPrice(){
            try{
                const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
                const d=await r.json();
                const p=d.bitcoin.usd,c=d.bitcoin.usd_24h_change;
                document.getElementById('btcPrice').textContent='$'+p.toLocaleString('en-US',{maximumFractionDigits:0});
                const e=document.getElementById('btcChange');
                e.textContent=(c>0?'+':'')+c.toFixed(2)+'% (24h)';
                e.className='btc-change '+(c>0?'positive':'negative');
            }catch(e){}
        }
        
        async function fetchHistoricalData(){
            try{
                console.log('Fetching historical data...');
                const r=await fetch('/api/fgi?history=true');
                const d=await r.json();
                console.log('Historical data received:',d);
                if(d.history&&d.history.length>0){
                    renderChart(d.history);
                }else{
                    console.error('No history data in response');
                }
            }catch(e){
                console.error('Chart error:',e);
            }
        }
        
        function renderChart(h){
            const canvasEl=document.getElementById('historyChart');
            if(!canvasEl){
                console.error('Chart canvas not found');
                return;
            }
            const ctx=canvasEl.getContext('2d');
            
            // Destroy existing chart if any
            if(window.chartInstance){
                window.chartInstance.destroy();
            }
            
            window.chartInstance=new Chart(ctx,{
                type:'line',
                data:{
                    labels:h.map(d=>d.date),
                    datasets:[{
                        label:'Fear & Greed Score',
                        data:h.map(d=>d.score),
                        borderColor:'#00ff00',
                        backgroundColor:'rgba(0,255,0,0.1)',
                        tension:0.4,
                        fill:true,
                        pointBackgroundColor:h.map(d=>getColorForScore(d.score)),
                        pointBorderColor:'#fff',
                        pointBorderWidth:2,
                        pointRadius:4,
                        pointHoverRadius:6
                    }]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:true,
                    plugins:{
                        legend:{
                            display:true,
                            labels:{color:'#00ff00',font:{family:'Courier New',size:12}}
                        }
                    },
                    scales:{
                        y:{
                            beginAtZero:true,
                            max:100,
                            grid:{color:'rgba(0,255,0,0.1)'},
                            ticks:{color:'#00ff00',font:{family:'Courier New'}}
                        },
                        x:{
                            grid:{color:'rgba(0,255,0,0.1)'},
                            ticks:{
                                color:'#00ff00',
                                font:{family:'Courier New',size:10},
                                maxRotation:45,
                                minRotation:45
                            }
                        }
                    }
                }
            });
            console.log('Chart rendered successfully');
        }
        
        async function fetchData(){
            try{
                const r=await fetch('/api/fgi');
                const d=await r.json();
                const prevScore=currentScore;
                currentScore=d.meta_score;
                const c=getColorForScore(currentScore);
                const e=currentScore<=20||currentScore>=80;
                
                // Play sound when state changes
                if(prevScore!==0&&prevScore!==currentScore){
                    playSound(getSoundStateForScore(currentScore));
                }
                
                if(e&&notificationsEnabled&&(lastNotificationScore===null||Math.abs(lastNotificationScore-currentScore)>10)){
                    new Notification(currentScore<=20?'üî• EXTREME FEAR!':'‚ö†Ô∏è EXTREME GREED!',{body:'Score: '+currentScore+(currentScore<=20?' - Accumulate?':' - Take profits?')});
                    lastNotificationScore=currentScore;
                }else if(!e){lastNotificationScore=null;}
                
                document.getElementById('content').innerHTML='<div class="gauge '+(e?'extreme':'')+'" style="border-color:'+c+';"><div class="score" style="color:'+c+'">'+d.meta_score+'</div><div class="status" style="color:'+c+'">'+d.status+'</div></div><div class="degen" style="color:'+c+'">'+d.degen_status+'</div><button class="btn" onclick="refreshAll()">[  REFRESH  ]</button><div style="color:#00ff00;font-size:0.8em;opacity:0.6;">> '+new Date(d.timestamp).toLocaleTimeString()+'</div>';
            }catch(e){
                document.getElementById('content').innerHTML='<div style="color:#ff6b6b;">ERROR: '+e.message+'</div>';
            }
        }
        
        function shareToX(){
            const s=currentScore<20?'BLOOD IN THE STREETS':currentScore<40?'PAPER HANDS EVERYWHERE':currentScore<60?'CRAB MARKET':currentScore<80?'FOMO KICKING IN':'EUPHORIA - TOP IS IN';
            const e=currentScore<20?'üî•':currentScore<40?'üíé':currentScore<60?'ü¶Ä':currentScore<80?'üöÄ':'‚ö†Ô∏è';
            const t=e+' Crypto Fear & Greed: '+currentScore+'/100\n\nStatus: '+s+'\n\nCheck it live:';
            window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(t)+'&url='+encodeURIComponent(window.location.href),'_blank','width=550,height=420');
        }
        
        function refreshAll(){
            fetchData();
            fetchBTCPrice();
            fetchHistoricalData();
        }
        
        fetchData();
        fetchBTCPrice();
        fetchHistoricalData();
        setInterval(fetchBTCPrice,30000);
        setInterval(fetchData,60000);
    </script>
</body>
</html>