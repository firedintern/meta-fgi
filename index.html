<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>> FEAR_GREED_PROTOCOL <</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #000; color: #fff; min-height: 100vh; overflow-x: hidden; position: relative; }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; }
        .container { text-align: center; max-width: 1000px; width: 100%; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        
        .controls { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }
        .control-btn { background: rgba(0, 255, 0, 0.2); border: 2px solid #00ff00; color: #00ff00; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 1.2em; transition: all 0.3s ease; position: relative; }
        .control-btn:hover { background: rgba(0, 255, 0, 0.4); transform: scale(1.1); }
        .control-btn:hover::after { content: attr(data-tooltip); position: absolute; bottom: -40px; right: 0; background: rgba(0, 255, 0, 0.9); color: #000; padding: 5px 10px; border-radius: 5px; font-size: 0.7em; white-space: nowrap; z-index: 1000; }
        .control-btn.active { background: #00ff00; color: #000; box-shadow: 0 0 15px #00ff00; }
        
        .btc-ticker { background: linear-gradient(135deg, #f7931a 0%, #ffb74d 100%); padding: 15px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(247, 147, 26, 0.3); animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .btc-label { font-size: 0.9em; color: #000; opacity: 0.8; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
        .btc-price { font-size: 2.5em; font-weight: bold; color: #000; margin: 5px 0; }
        .btc-change { font-size: 1.2em; font-weight: bold; margin-top: 5px; }
        .positive { color: #00ff00; }
        .negative { color: #ff0000; }
        
        .title { font-size: 2.2em; color: #00ff00; margin-bottom: 25px; font-weight: bold; letter-spacing: 3px; text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00; animation: terminal-flicker 3s ease-in-out infinite; }
        @keyframes terminal-flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.95; } }
        
        /* Speedometer Gauge */
        .speedometer-container { width: 450px; height: 450px; margin: 30px auto; position: relative; }
        .speedometer { width: 100%; height: 100%; position: relative; }
        .gauge-bg { width: 100%; height: 100%; }
        .score-display { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .score-number { font-size: 5em; font-weight: bold; text-shadow: 0 0 30px currentColor; line-height: 1; }
        .score-label { font-size: 1.2em; margin-top: 10px; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }
        .gauge-extreme { animation: extreme-pulse 1s ease-in-out infinite; }
        @keyframes extreme-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .degen { font-size: 3em; font-family: 'Comic Sans MS', cursive, sans-serif; color: #fff; margin: 30px; font-weight: bold; text-shadow: 0 0 20px currentColor; animation: degen-bounce 2s ease-in-out infinite; }
        @keyframes degen-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .chart-container { background: rgba(255,255,255,0.05); border: 2px solid rgba(0, 255, 0, 0.3); border-radius: 15px; padding: 30px; margin: 40px 0; box-shadow: 0 0 20px rgba(0, 255, 0, 0.1); min-height: 350px; }
        .chart-title { color: #00ff00; font-size: 1.3em; margin-bottom: 20px; letter-spacing: 2px; text-transform: uppercase; }
        
        .btn { background: linear-gradient(135deg, #00ff00, #00cc00); border: 2px solid #00ff00; color: #000; padding: 15px 40px; font-size: 1.1em; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold; margin: 10px; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 0 15px rgba(0, 255, 0, 0.3); transition: all 0.3s ease; }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(0, 255, 0, 0.6); }
        .share-btn { background: #000; border: 2px solid #fff; color: #fff; display: inline-flex; align-items: center; gap: 8px; }
        .share-btn:hover { box-shadow: 0 0 25px rgba(255, 255, 255, 0.6); background: #111; }
        
        @media (max-width: 768px) { 
            .title { font-size: 1.5em; } 
            .degen { font-size: 2em; } 
            .btc-price { font-size: 2em; } 
            .speedometer-container { width: 300px; height: 300px; }
            .score-number { font-size: 3.5em; } 
            .score-label { font-size: 1em; }
            .controls { top: 10px; right: 10px; flex-direction: column; } 
            .chart-container { padding: 15px; } 
        }
    </style>
</head>
<body>
    <canvas id="matrix-canvas"></canvas>
    <audio id="bgMusic" loop></audio>
    
    <div class="controls">
        <button class="control-btn" id="soundToggle" data-tooltip="Toggle Music">üîä</button>
        <button class="control-btn active" id="particlesToggle" data-tooltip="Toggle Matrix">‚ú®</button>
        <button class="control-btn" id="notifyToggle" data-tooltip="Extreme alerts">üîî</button>
    </div>
    
    <div class="container">
        <div class="btc-ticker">
            <div class="btc-label">‚Çø Bitcoin</div>
            <div class="btc-price" id="btcPrice">Loading...</div>
            <div class="btc-change" id="btcChange"></div>
        </div>
        
        <div class="title">&gt; FEAR_GREED_PROTOCOL &lt;</div>
        
        <div id="content">
            <div class="speedometer-container">
                <svg class="speedometer" viewBox="0 0 200 200">
                    <!-- Background arc -->
                    <defs>
                        <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ff4444;stop-opacity:1" />
                            <stop offset="25%" style="stop-color:#ff8844;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#ffd700;stop-opacity:1" />
                            <stop offset="75%" style="stop-color:#88ff44;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#44ff88;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- Gauge arc -->
                    <path id="gaugeArc" d="M 30 170 A 80 80 0 1 1 170 170" fill="none" stroke="url(#gaugeGradient)" stroke-width="20" stroke-linecap="round"/>
                    <!-- Tick marks -->
                    <g id="ticks">
                        <line x1="30" y1="170" x2="30" y2="160" stroke="#fff" stroke-width="2" opacity="0.5"/>
                        <line x1="50" y1="145" x2="55" y2="138" stroke="#fff" stroke-width="2" opacity="0.5"/>
                        <line x1="75" y1="125" x2="82" y2="120" stroke="#fff" stroke-width="2" opacity="0.5"/>
                        <line x1="100" y1="110" x2="100" y2="100" stroke="#fff" stroke-width="2" opacity="0.5"/>
                        <line x1="125" y1="125" x2="118" y2="120" stroke="#fff" stroke-width="2" opacity="0.5"/>
                        <line x1="150" y1="145" x2="145" y2="138" stroke="#fff" stroke-width="2" opacity="0.5"/>
                        <line x1="170" y1="170" x2="170" y2="160" stroke="#fff" stroke-width="2" opacity="0.5"/>
                    </g>
                    <!-- Needle -->
                    <g id="needle" transform="rotate(0 100 170)">
                        <line x1="100" y1="170" x2="100" y2="100" stroke="#fff" stroke-width="4" stroke-linecap="round"/>
                        <circle cx="100" cy="170" r="8" fill="#fff"/>
                    </g>
                </svg>
                <div class="score-display">
                    <div class="score-number" id="scoreNumber">--</div>
                    <div class="score-label" id="scoreLabel">LOADING</div>
                </div>
            </div>
            <div class="degen" id="degenStatus">...</div>
            <button class="btn" onclick="refreshAll()">[  REFRESH  ]</button>
            <div style="color:#00ff00;font-size:0.8em;opacity:0.6;" id="timestamp">> --:--:--</div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">üìä 30-Day Sentiment History</div>
            <canvas id="historyChart"></canvas>
        </div>
        
        <button class="btn share-btn" onclick="shareToX()">Share on <span style="font-size:1.3em">ùïè</span></button>
    </div>
    
    <script>
        let currentScore=0,soundEnabled=false,particlesEnabled=true,notificationsEnabled=false,lastNotificationScore=null;
        const bgMusic=document.getElementById('bgMusic');
        let currentState='';
        
        const musicTracks={
            extreme_fear:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Myst%20on%20the%20Moor.mp3',
            fear:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Interloper.mp3',
            neutral:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Pixel%20Peeker%20Polka%20-%20Faster.mp3',
            greed:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Martian%20Cowboy.mp3',
            extreme_greed:'https://incompetech.com/music/royalty-free/mp3-royaltyfree/Rocket.mp3'
        };
        
        function playMusicForState(state){
            if(!soundEnabled)return;
            if(state===currentState&&!bgMusic.paused)return;
            currentState=state;
            const url=musicTracks[state];
            if(url){
                bgMusic.src=url;
                bgMusic.volume=0.3;
                bgMusic.play().catch(e=>console.log('Music:',e.message));
            }
        }
        
        function stopMusic(){
            bgMusic.pause();
            bgMusic.currentTime=0;
            currentState='';
        }
        
        function getSoundStateForScore(s){
            if(s<20)return 'extreme_fear';
            if(s<40)return 'fear';
            if(s<60)return 'neutral';
            if(s<80)return 'greed';
            return 'extreme_greed';
        }
        
        // Matrix
        const canvas=document.getElementById('matrix-canvas'),ctx=canvas.getContext('2d');
        canvas.width=window.innerWidth;canvas.height=window.innerHeight;
        const matrix="ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%‚ÇøüßÆüìä";
        const fontSize=14,columns=canvas.width/fontSize;
        const drops=[];
        for(let i=0;i<columns;i++)drops[i]=1;
        
        function drawMatrix(){
            if(!particlesEnabled)return;
            ctx.fillStyle='rgba(0,0,0,0.05)';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle='#0F0';
            ctx.font=fontSize+'px monospace';
            for(let i=0;i<drops.length;i++){
                const text=matrix[Math.floor(Math.random()*matrix.length)];
                ctx.fillText(text,i*fontSize,drops[i]*fontSize);
                if(drops[i]*fontSize>canvas.height&&Math.random()>0.975)drops[i]=0;
                drops[i]++;
            }
        }
        setInterval(drawMatrix,35);
        window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;});
        
        function getColorForScore(s){
            if(s<20)return '#ff4444';
            if(s<40)return '#ff8844';
            if(s<60)return '#ffd700';
            if(s<80)return '#88ff44';
            return '#44ff88';
        }
        
        function updateSpeedometer(score){
            const angle=(score/100)*180-90;
            const needle=document.getElementById('needle');
            needle.setAttribute('transform','rotate('+angle+' 100 170)');
            
            const color=getColorForScore(score);
            document.getElementById('scoreNumber').style.color=color;
            document.getElementById('scoreNumber').textContent=score;
            
            if(score<=20||score>=80){
                document.querySelector('.speedometer-container').classList.add('gauge-extreme');
            }else{
                document.querySelector('.speedometer-container').classList.remove('gauge-extreme');
            }
        }
        
        document.getElementById('soundToggle').addEventListener('click',function(){
            soundEnabled=!soundEnabled;
            this.classList.toggle('active');
            this.textContent=soundEnabled?'üîä':'üîá';
            if(soundEnabled&&currentScore>0){
                playMusicForState(getSoundStateForScore(currentScore));
            }else{
                stopMusic();
            }
        });
        
        document.getElementById('particlesToggle').addEventListener('click',function(){
            particlesEnabled=!particlesEnabled;
            this.classList.toggle('active');
            if(!particlesEnabled){ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);}
        });
        
        document.getElementById('notifyToggle').addEventListener('click',async function(){
            if(!notificationsEnabled&&'Notification'in window){
                const p=await Notification.requestPermission();
                if(p==='granted'){
                    notificationsEnabled=true;
                    this.classList.add('active');
                    new Notification('üîî Alerts Enabled!',{body:'Extreme level notifications on'});
                }
            }else{
                notificationsEnabled=false;
                this.classList.remove('active');
            }
        });
        
        async function fetchBTCPrice(){
            try{
                const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
                const d=await r.json();
                const p=d.bitcoin.usd,c=d.bitcoin.usd_24h_change;
                document.getElementById('btcPrice').textContent='$'+p.toLocaleString('en-US',{maximumFractionDigits:0});
                const e=document.getElementById('btcChange');
                e.textContent=(c>0?'+':'')+c.toFixed(2)+'% (24h)';
                e.className='btc-change '+(c>0?'positive':'negative');
            }catch(e){}
        }
        
        async function fetchHistoricalData(){
            try{
                console.log('Fetching historical data...');
                const r=await fetch('/api/fgi?history=true');
                if(!r.ok)throw new Error('API error');
                const d=await r.json();
                
                if(d.history&&Array.isArray(d.history)&&d.history.length>0){
                    console.log('Got '+d.history.length+' data points');
                    renderChart(d.history);
                }else{
                    document.querySelector('.chart-title').innerHTML='üìä Historical data unavailable<br><small style="font-size:0.7em">Consider adding Altcoin Season Index</small>';
                }
            }catch(e){
                console.error('History fetch failed:',e);
                document.querySelector('.chart-title').innerHTML='üìä Unable to load historical data';
            }
        }
        
        function renderChart(h){
            const el=document.getElementById('historyChart');
            if(!el||typeof Chart==='undefined')return;
            const c=el.getContext('2d');
            if(window.chartInstance)window.chartInstance.destroy();
            
            try{
                window.chartInstance=new Chart(c,{
                    type:'line',
                    data:{
                        labels:h.map(d=>d.date),
                        datasets:[{
                            label:'Fear & Greed',
                            data:h.map(d=>d.score),
                            borderColor:'#00ff00',
                            backgroundColor:'rgba(0,255,0,0.1)',
                            borderWidth:3,
                            tension:0.4,
                            fill:true,
                            pointBackgroundColor:h.map(d=>getColorForScore(d.score)),
                            pointBorderColor:'#fff',
                            pointBorderWidth:2,
                            pointRadius:5,
                            pointHoverRadius:7
                        }]
                    },
                    options:{
                        responsive:true,
                        maintainAspectRatio:true,
                        plugins:{legend:{labels:{color:'#00ff00',font:{family:'Courier New',size:14}}}},
                        scales:{
                            y:{beginAtZero:true,max:100,grid:{color:'rgba(0,255,0,0.2)'},ticks:{color:'#00ff00',font:{family:'Courier New'}}},
                            x:{grid:{color:'rgba(0,255,0,0.1)'},ticks:{color:'#00ff00',font:{family:'Courier New',size:11},maxRotation:45,minRotation:45}}
                        }
                    }
                });
                console.log('Chart rendered!');
            }catch(e){console.error('Chart error:',e);}
        }
        
        async function fetchData(){
            try{
                const r=await fetch('/api/fgi');
                const d=await r.json();
                const prevScore=currentScore;
                currentScore=d.meta_score;
                const color=getColorForScore(currentScore);
                
                updateSpeedometer(currentScore);
                document.getElementById('scoreLabel').textContent=d.status;
                document.getElementById('scoreLabel').style.color=color;
                document.getElementById('degenStatus').textContent=d.degen_status;
                document.getElementById('degenStatus').style.color=color;
                document.getElementById('timestamp').textContent='> '+new Date(d.timestamp).toLocaleTimeString();
                
                if(prevScore!==0&&prevScore!==currentScore&&soundEnabled){
                    playMusicForState(getSoundStateForScore(currentScore));
                }
                
                const extreme=currentScore<=20||currentScore>=80;
                if(extreme&&notificationsEnabled&&(lastNotificationScore===null||Math.abs(lastNotificationScore-currentScore)>10)){
                    new Notification(currentScore<=20?'üî• EXTREME FEAR!':'‚ö†Ô∏è EXTREME GREED!',{body:'Score: '+currentScore});
                    lastNotificationScore=currentScore;
                }else if(!extreme){lastNotificationScore=null;}
            }catch(e){
                document.getElementById('scoreLabel').textContent='ERROR';
                console.error(e);
            }
        }
        
        function shareToX(){
            const s=currentScore<20?'BLOOD IN THE STREETS':currentScore<40?'PAPER HANDS EVERYWHERE':currentScore<60?'CRAB MARKET':currentScore<80?'FOMO KICKING IN':'EUPHORIA - TOP IS IN';
            const e=currentScore<20?'üî•':currentScore<40?'üíé':currentScore<60?'ü¶Ä':currentScore<80?'üöÄ':'‚ö†Ô∏è';
            const t=e+' Crypto Fear & Greed: '+currentScore+'/100\n\nStatus: '+s+'\n\nCheck it live:';
            window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(t)+'&url='+encodeURIComponent(window.location.href),'_blank','width=550,height=420');
        }
        
        function refreshAll(){
            fetchData();
            fetchBTCPrice();
            fetchHistoricalData();
        }
        
        setTimeout(()=>{
            fetchData();
            fetchBTCPrice();
            fetchHistoricalData();
        },100);
        
        setInterval(fetchBTCPrice,30000);
        setInterval(fetchData,60000);
    </script>
</body>
</html>